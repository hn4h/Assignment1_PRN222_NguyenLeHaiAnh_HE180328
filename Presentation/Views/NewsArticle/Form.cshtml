@using NguyenLeHaiAnh_HE180328_Assignment1.DataAccess.Models
@model NewsArticle

@{
    var tags = ViewBag.Tags as IEnumerable<Tag> ?? new List<Tag>();
    var sel = ViewBag.SelectedTags as IEnumerable<int> ?? new List<int>();

    bool isCreate = string.IsNullOrEmpty(Model.NewsArticleId);
}

@Html.ValidationSummary(false, "", new { @class = "text-danger" })

<form asp-action="@(isCreate ? "Create" : "Edit")" method="post" data-ajax="true">
    @Html.AntiForgeryToken()

    <div class="modal-header">
        <h5 class="modal-title">@(isCreate ? "Create News" : "Edit News")</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">
        <div class="mb-3">
            <label asp-for="NewsTitle" class="form-label"></label>
            <input asp-for="NewsTitle" class="form-control" required />
            <span asp-validation-for="NewsTitle" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="Headline" class="form-label"></label>
            <input asp-for="Headline" class="form-control" />
        </div>
        @if (!isCreate)
        {
            <div class="mb-3">
                <label class="form-label">Modified</label>
                <input class="form-control" value="@Model.ModifiedDate?.ToString("dd/MM/yyyy HH:mm")" readonly />
            </div>

            <div class="mb-3">
                <label class="form-label">Last Updated By</label>
                <input class="form-control" value="@Model.UpdatedBy?.AccountName" readonly />
            </div>
        }

        <div class="mb-3">
            <label asp-for="NewsSource" class="form-label"></label>
            <input asp-for="NewsSource" class="form-control" />
            <span asp-validation-for="NewsSource" class="text-danger"></span>
        </div>


        <div class="mb-3">
            <label asp-for="NewsContent" class="form-label"></label>
            <textarea asp-for="NewsContent" rows="5" class="form-control" required></textarea>
            <span asp-validation-for="NewsContent" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label asp-for="CategoryId" class="form-label"></label>
            <select asp-for="CategoryId" asp-items="ViewBag.CategoryList" class="form-select" required>
                <option value="">-- Select --</option>
            </select>
            <span asp-validation-for="CategoryId" class="text-danger"></span>
        </div>

        <div class="mb-3">
            <label class="form-label">Tags (min 1)</label>
            <div>
                @foreach (var t in tags)
                {
                    var checkedAttr = sel.Contains(t.TagId) ? "checked" : "";
                    <div class="form-check">
                        <input type="checkbox" name="tags" value="@t.TagId"
                               class="form-check-input" id="tag_@t.TagId" @checkedAttr />
                        <label class="form-check-label" for="tag_@t.TagId">@t.TagName</label>
                    </div>
                }
            </div>
        </div>

        <div class="form-check mb-3">
            <input type="checkbox" name="NewsStatus" value="true"
                   class="form-check-input" id="NewsStatus"
            @(Model.NewsStatus == true ? "checked" : "") />
            <label class="form-check-label" for="NewsStatus">Active</label>
        </div>

        <input type="hidden" name="NewsStatus" value="false" />
    </div>

    <div class="modal-footer">
        <button type="submit" id="saveButton" class="btn btn-success">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
    </div>
    @if (!string.IsNullOrEmpty(Model.NewsArticleId))
    {
        <input type="hidden" asp-for="NewsArticleId" />
    }

</form>

<script>
    $(function () {
        function validateTags() {
            var checkedCount = $('input[name="tags"]:checked').length;
            $('#saveButton').prop('disabled', checkedCount === 0);
        }

        validateTags();
        $('input[name="tags"]').on('change', validateTags);
    });
</script>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
}